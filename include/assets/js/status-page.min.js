const REFRESH_PERIOD=5*60*1000;const RESIZE_UPDATE_DELAY=500;let updateTimer=null;let resizeUpdateTimer=null;let startTimestamp=null;let endTimestamp=null;let latencyScale=0;let regionId=null;let monitorId=null;let customerRegionsById=null;let customerMonitorsById=null;let customerMonitorsByUserOrder=null;let customerActiveUserOrderValues=null;let customerAuthorities=null;let customerStatus=null;let customerEvents=null;let newestEventByMonitorId=null;let userStringsFromEventTypes=ajax_object.user_strings_from_event_types;let userStringsFromStatus=ajax_object.user_strings_from_status;let userStrings=ajax_object.user_strings;let defaultPlotFile=ajax_object.default_plot_file;function inesonicSpeedSentryReportErrorCondition(a){alert("Lost communication with your website:"+a)}function inesonicSpeedSentryUpdateRegionSelector(){let selectElement=document.getElementById("inesonic-speedsentry-region-select-control");while(selectElement.options.length>1){selectElement.options.remove(1)}let regionIds=Object.keys(customerRegionsById).sort();for(let i=0;i<regionIds.length;++i){let regionId=regionIds[i];let regionName=customerRegionsById[regionId].description;let optionElement=document.createElement("option");optionElement.value=regionId;("textContent" in optionElement)?(optionElement.textContent=regionName):(optionElement.innerText=regionName);selectElement.options.add(optionElement)}}function inesonicSpeedSentryUpdateRegions(){if(customerRegionsById===null&&inesonicSpeedSentryLastCapabilities.multi_region_checking){jQuery.ajax({type:"POST",url:ajax_object.ajax_url,data:{action:"inesonic_speedsentry_regions_list"},dataType:"json",success:function(a){if(a!==null&&a.status=="OK"){customerRegionsById=a.regions;inesonicSpeedSentryUpdateRegionSelector()}else{inesonicSpeedSentryReportErrorCondition(a.status)}}})}}function inesonicSpeedSentryUpdateMonitorSelector(){let selectElement=document.getElementById("inesonic-speedsentry-monitor-select-control");while(selectElement.options.length>1){selectElement.options.remove(1)}let hostSchemeIds=Object.keys(customerAuthorities).sort();for(let i=0;i<hostSchemeIds.length;++i){let hostSchemeId=hostSchemeIds[i];let authority=customerAuthorities[hostSchemeId];let optionText=userStrings.all_monitors_on.replace("{0}",authority.url);let optionElement=document.createElement("option");optionElement.value=-hostSchemeId;("textContent" in optionElement)?(optionElement.textContent=optionText):(optionElement.innerText=optionText);selectElement.options.add(optionElement)}for(let i=0;i<customerActiveUserOrderValues.length;++i){let userOrder=customerActiveUserOrderValues[i];let monitor=customerMonitorsByUserOrder[userOrder];let monitorId=monitor.monitor_id;let optionElement=document.createElement("option");optionElement.value=monitorId;("textContent" in optionElement)?(optionElement.textContent=monitor.url):(optionElement.innerText=monitor.url);selectElement.options.add(optionElement)}}function inesonicSpeedSentryBuildEventsTable(){let eventsTableBody=jQuery("#inesonic-speedsentry-events-body");eventsTableBody.empty();newestEventByMonitorId={};for(let index=0;index<customerEvents.length;++index){let event=customerEvents[index];let monitorId=event.monitor_id;let eventType=event.event_type.toUpperCase();let eventTypeString=userStringsFromEventTypes[eventType];let eventTimestamp=event.timestamp;let eventMessage=event.message;let eventDateTime=moment.unix(eventTimestamp);let eventDateTimeString=eventDateTime.format("LLL");let monitor=(monitorId in customerMonitorsById)?customerMonitorsById[monitorId]:null;let eventUrl="???";if(monitor!==null){if(eventType=="SSL_CERTIFICATE_EXPIRING"||eventType=="SSL_CERTIFICATE_RENEWED"){let hostSchemeId=monitor.host_scheme_id;if(hostSchemeId in customerAuthorities){let authority=customerAuthorities[hostSchemeId];eventUrl=authority.url}}else{eventUrl=monitor.url}}let eventsTableRow=document.createElement("tr");eventsTableRow.className="inesonic-speedsentry-events-row";let eventsTableTimestamp=document.createElement("td");eventsTableTimestamp.className="inesonic-speedsentry-events-datetime";("textContent" in eventsTableTimestamp)?(eventsTableTimestamp.textContent=eventDateTimeString):(eventsTableTimestamp.innerText=eventDataTimeString);let eventsTableType=document.createElement("td");eventsTableType.className="inesonic-speedsentry-events-type";("textContent" in eventsTableType)?(eventsTableType.textContent=eventTypeString):(eventsTableType.innerText=eventTypeString);let eventsTableUrl=document.createElement("td");eventsTableUrl.className="inesonic-speedsentry-events-url";("textContent" in eventsTableUrl)?(eventsTableUrl.textContent=eventUrl):(eventTableUrl.innerText=eventUrl);let eventsTableNotes=document.createElement("td");eventsTableNotes.className="inesonic-speedsentry-events-notes";("textContent" in eventsTableNotes)?(eventsTableNotes.textContent=eventMessage):(eventTableNotes.innerText=eventUrl);eventsTableRow.append(eventsTableTimestamp);eventsTableRow.append(eventsTableType);eventsTableRow.append(eventsTableUrl);eventsTableRow.append(eventsTableNotes);eventsTableBody.append(eventsTableRow);event.datetime=eventDateTimeString;event.event_type_string=eventTypeString;event.url=eventUrl;!(monitorId in newestEventByMonitorId)&&(newestEventByMonitorId[monitorId]=event)}}function inesonicSpeedSentryBuildStatusAlertsTable(){let showAllStatus=(jQuery("#inesonic-speedsentry-status-alerts-button").text()==userStrings.show_alerts_only);let statusAlertTableBody=jQuery("#inesonic-speedsentry-status-alerts-body");statusAlertTableBody.empty();for(let i=0;i<customerActiveUserOrderValues.length;++i){let userOrder=customerActiveUserOrderValues[i];let monitor=customerMonitorsByUserOrder[userOrder];let monitorId=monitor.monitor_id;let lastAlert="---";let statusValue="UNKNOWN";let status="";if(monitorId in newestEventByMonitorId){lastAlert=newestEventByMonitorId[monitorId].event_type_string}if(monitorId in customerStatus){statusValue=customerStatus[monitorId].toUpperCase()}status=userStringsFromStatus[statusValue];if(showAllStatus||statusValue=="FAILED"){let statusTableRow=document.createElement("tr");statusTableRow.className="inesonic-speedsentry-status-alerts-row";let statusUrl=document.createElement("td");statusUrl.className="inesonic-speedsentry-status-alerts-url";("textContent" in statusUrl)?(statusUrl.textContent=monitor.url):(statusUrl.innerText=monitor.url);let statusLastEvent=document.createElement("td");statusLastEvent.className="inesonic-speedsentry-status-alerts-last-event";("textContent" in statusLastEvent)?(statusLastEvent.textContent=lastAlert):(statusLastEvent.innerText=lastAlert);let statusCurrent=document.createElement("td");if(status!="Working"){statusCurrent.className=("inesonic-speedsentry-status-alerts-current-status inesonic-speedsentry-status-alerts-current-status-error")}else{statusCurrent.className="inesonic-speedsentry-status-alerts-current-status"}("textContent" in statusCurrent)?(statusCurrent.textContent=status):(statusCurrent.innerText=status);statusTableRow.append(statusUrl);statusTableRow.append(statusLastEvent);statusTableRow.append(statusCurrent);statusAlertTableBody.append(statusTableRow)}}}function inesonicSpeedSentryBuildSslTable(){let sslTableBody=jQuery("#inesonic-speedsentry-ssl-body");sslTableBody.empty();for(let id in customerAuthorities){let authority=customerAuthorities[id];let url=authority.url;let expirationTimestamp=authority.ssl_expiration_timestamp;let expirationDateTimeString;if(expirationTimestamp!=0){let expirationDateTime=moment.unix(expirationTimestamp);expirationDateTimeString=expirationDateTime.format("LLL")}else{expirationDateTimeString="---"}let sslTableRow=document.createElement("tr");sslTableRow.className="inesonic-speedsentry-ssl-row";let sslTableAuthority=document.createElement("td");sslTableAuthority.className="inesonic-speedsentry-ssl-authority";("textContent" in sslTableAuthority)?(sslTableAuthority.textContent=url):(sslTableAuthority.innerText=url);let sslTableExpirationDateTime=document.createElement("td");sslTableExpirationDateTime.className="inesonic-speedsentry-ssl-expiration-datetime";("textContent" in sslTableExpirationDateTime)?(sslTableExpirationDateTime.textContent=expirationDateTimeString):(sslTableExpirationDateTime.innerText=expirationDateTimeString);sslTableRow.append(sslTableAuthority);sslTableRow.append(sslTableExpirationDateTime);sslTableBody.append(sslTableRow)}}function inesonicSpeedSentryUpdateTables(){jQuery.ajax({type:"POST",url:ajax_object.ajax_url,data:{action:"inesonic_speedsentry_multiple_list"},dataType:"json",success:function(a){if(a!==null){customerAuthorities=a.authorities;customerStatus=a.status;customerMonitorsByUserOrder=a.monitors;customerEventsUnordered=a.events;customerMonitorsById={};for(let userOrder in customerMonitorsByUserOrder){let monitor=customerMonitorsByUserOrder[userOrder];let monitorId=monitor.monitor_id;let hostSchemeId=monitor.host_scheme_id;let url="???";if(hostSchemeId in customerAuthorities){let authority=customerAuthorities[hostSchemeId];url=authority.url;if(monitor.path.startsWith("/")){if(url.endsWith("/")){url=url.slice(0,-1)}url+=monitor.path}else{if(url.endsWith("/")){url+=monitor.path}else{url+="/"+monitor.path}}}monitor.url=url;customerMonitorsById[monitor.monitor_id]=monitor}customerActiveUserOrderValues=Object.keys(customerMonitorsByUserOrder).sort();customerEvents=Object.values(customerEventsUnordered);customerEvents.sort(function(d,c){return c.timestamp-d.timestamp});if(inesonicSpeedSentryLastCapabilities.supports_latency_tracking){inesonicSpeedSentryUpdateMonitorSelector()}inesonicSpeedSentryBuildEventsTable();inesonicSpeedSentryBuildStatusAlertsTable();if(inesonicSpeedSentryLastCapabilities.supports_ssl_expiration_checking){inesonicSpeedSentryBuildSslTable()}}else{inesonicSpeedSentryReportErrorCondition(a.status)}}})}function inesonicSpeedSentryPlotRequest(d,f,c,a,e){e.action="inesonic_speedsentry_latency_plot";e.plot_type=f;e.title="";e.x_axis_label="";e.y_axis_label="";e.width=c;e.height=a;e.format="PNG";if(latencyScale>0){e.maximum_latency=1*latencyScale}if(startTimestamp!==null){e.start_timestamp=startTimestamp}if(endTimestamp!==null){e.end_timestamp=endTimestamp}if(regionId!==null){e.region_id=regionId}if(monitorId!==null){if(monitorId<0){e.host_scheme_id=-monitorId}else{e.monitor_id=monitorId}}jQuery.ajax({type:"POST",url:ajax_object.ajax_url,data:e,dataType:"json",success:function(g){let image=jQuery("#"+d);if(g.status=="OK"){base64Image=g.image;image.attr("src","data:image/png;base64,"+base64Image)}else{image.attr("src",defaultPlotFile)}let currentTimestamp=(new Date()).getTime();document.getElementById(d).className="inesonic-speedsentry-image dummy_class_"+currentTimestamp}})}function inesonicSpeedSentryUpdateLatencyPlot(){let totalWidth=jQuery("#inesonic-speedsentry-monitor-status-top").width();let xAxisLabelWidth=jQuery("#inesonic-speedsentry-latency-histogram-x-axis-label").height();let statusTableWidth=jQuery("#inesonic-speedsentry-status-alerts").width();let imageWidth=Math.min(2047,totalWidth-xAxisLabelWidth-40-statusTableWidth);let imageHeight=0;let maximumHeight=Math.min(1536,Math.floor((3*window.screen.availHeight)/4));if(imageWidth<300){imageWidth=Math.min(2047,totalWidth-xAxisLabelWidth);imageHeight=Math.min(maximumHeight,Math.max(512,Math.ceil(imageWidth/2)))}else{imageHeight=Math.min(maximumHeight,Math.max(512,Math.ceil((3*imageWidth)/4)))}inesonicSpeedSentryPlotRequest("inesonic-speedsentry-latency-histogram-image","histogram",imageWidth,imageHeight,{})}function inesonicSpeedSentryUpdateHistoryPlot(){let availableWidth=(jQuery("#inesonic-speedsentry-history-inner").width()-jQuery("#inesonic-speedsentry-history-y-axis-label").width());let imageWidth=Math.min(2047,Math.max(300,Math.floor(availableWidth)));let maximumHeight=Math.min(1536,Math.floor((3*window.screen.availHeight)/4));let imageHeight=Math.min(maximumHeight,Math.max(400,Math.ceil(imageWidth/3)));inesonicSpeedSentryPlotRequest("inesonic-speedsentry-history-image","history",imageWidth,imageHeight,{})}function inesonicSpeedSentryUpdatePlots(){if(inesonicSpeedSentryLastCapabilities.supports_latency_tracking){inesonicSpeedSentryUpdateLatencyPlot();inesonicSpeedSentryUpdateHistoryPlot()}}function inesonicSpeedSentryUpdateContent(){inesonicSpeedSentryUpdateRegions();inesonicSpeedSentryUpdateTables();inesonicSpeedSentryUpdatePlots()}function inesonicSpeedSentryEnableByClass(a,c){if(c){jQuery("."+a).attr("class",a+" inesonic-speedsentry-visible")}else{jQuery("."+a).attr("class",a+" inesonic-speedsentry-hidden")}}function inesonicShowTimezone(){jQuery(".timezone").text(moment.tz.guess())}jQuery(window).resize(function(){if(resizeUpdateTimer!==null){clearTimeout(resizeUpdateTimer)}resizeUpdateTimer=setTimeout(function(){jQuery(this).trigger("windowResized")},RESIZE_UPDATE_DELAY)});jQuery(document).ready(function(a){a("#inesonic-speedsentry-start-date").datepicker();a("#inesonic-speedsentry-end-date").datepicker();jQuery("#inesonic-speedsentry-capabilities").on("inesonic-speedsentry-capabilities-changed",function(d,c){let connectionIssue=true;let customerActive=false;let multiRegionChecking=false;let supportsLatencyTracking=true;let supportsMaintenanceMode=true;let supportsSSLExpirationChecking=false;let connected=false;if(c!==null){connectionIssue=false;customerActive=c.customer_active;multiRegionChecking=c.multi_region_checking;supportsLatencyTracking=c.supports_latency_tracking;supportsMaintenanceMode=c.supports_maintenance_mode;supportsSSLExpirationChecking=c.supports_ssl_expiration_checking;connected=c.connected}let isActive=!connectionIssue&&connected&&customerActive;let isUnconfirmed=!connectionIssue&&connected&&!customerActive;let isInactive=!connectionIssue&&!connected;inesonicSpeedSentryEnableByClass("inesonic-speedsentry-active",isActive);inesonicSpeedSentryEnableByClass("inesonic-speedsentry-unconfirmed",isUnconfirmed);inesonicSpeedSentryEnableByClass("inesonic-speedsentry-inactive",isInactive);inesonicSpeedSentryEnableByClass("inesonic-speedsentry-connection-issue",connectionIssue);let statusAlertsClass="inesonic-speedsentry-status-alerts";if(!supportsLatencyTracking){statusAlertsClass="inesonic-speedsentry-status-alerts-full-width"}jQuery("#inesonic-speedsentry-status-alerts").attr("class",statusAlertsClass);if(isActive){inesonicSpeedSentryEnableByClass("inesonic-speedsentry-supports-logging",supportsLatencyTracking);inesonicSpeedSentryEnableByClass("inesonic-speedsentry-supports-multi-region",multiRegionChecking);inesonicSpeedSentryEnableByClass("inesonic-speedsentry-supports-ssl-monitoring",supportsSSLExpirationChecking);if(updateTimer===null){inesonicSpeedSentryUpdateContent();updateTimer=setInterval(inesonicSpeedSentryUpdateContent,REFRESH_PERIOD)}}else{if(updateTimer!==null){clearInterval(updateTimer);updateTimer=null}}});jQuery("#inesonic-speedsentry-status-alerts-button").text(userStrings.show_alerts_only);jQuery("#inesonic-speedsentry-status-alerts-button").click(function(c){let b=jQuery("#inesonic-speedsentry-status-alerts-button");b.text(b.text()==userStrings.show_alerts_only?userStrings.show_all_monitors:userStrings.show_alerts_only);inesonicSpeedSentryBuildStatusAlertsTable()});a("#inesonic-speedsentry-start-date").on("change paste",function(){let newValue=a(this).val();startTimestamp=moment(moment(newValue).tz(moment.tz.guess()).utc().format()).unix();inesonicSpeedSentryUpdatePlots()});a("#inesonic-speedsentry-end-date").on("change paste",function(){let newValue=a(this).val();endTimestamp=moment(moment(newValue).tz(moment.tz.guess()).utc().format()).unix();inesonicSpeedSentryUpdatePlots()});a("#inesonic-speedsentry-start-clear-button").click(function(c){startTimestamp=null;a("#inesonic-speedsentry-start-date").val("");inesonicSpeedSentryUpdatePlots()});a("#inesonic-speedsentry-end-clear-button").click(function(c){endTimestamp=null;a("#inesonic-speedsentry-end-date").val("");inesonicSpeedSentryUpdatePlots()});a("#inesonic-speedsentry-latency-select-control").change(function(){latencyScale=a(this).val();inesonicSpeedSentryUpdatePlots()});a("#inesonic-speedsentry-region-select-control").change(function(){regionId=a(this).val();regionId=(regionId!=0)?regionId:null;inesonicSpeedSentryUpdatePlots()});a("#inesonic-speedsentry-monitor-select-control").change(function(){monitorId=a(this).val();monitorId=(monitorId!=0)?monitorId:null;inesonicSpeedSentryUpdatePlots()});jQuery(window).bind("windowResized",inesonicSpeedSentryUpdatePlots);inesonicShowTimezone()});